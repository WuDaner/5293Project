---
title: "Project_GR5293"
author: "Xiwen Chen"
date: "2019/4/27"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

## I. Introduction
Air Transport has become more and more important in many industries. It plays an important role not only in our personal life but also in the global economic activities. However, unfortunately, aviation accidents take place every year. Hence, we want to perform research on plane accidents.In this report, we will discuss the trend of accidents by year, the relationship of plane accidents and phase of the flight, the relationship between the plane accidents and weather condition and the relationship between accidents and the air transport type.

## II. Description of the data source
Our dataset comes from the NTSB accident database, which contains information from 1982 and later about civil accidents and some selected incidents. There is a report about the accident and its probable cause on the website. Although there are many aviation accidents database, the database of NTSB is more detailed and easy to download. The question we are concerned about can be solved by this database. Meanwhile, it has a corresponding report, so we can look at the report to find the information we need. 
There are more than 80,000 observations in this database, which contains the information from 1982 and 2019. In this database, it has variables about the date, the place and the casualties of the accidents. It also contains information about the plane, the engine and the air carrier, which can help us analyze the relationship between accidents and different variables.
As technology has improved a lot in recent years, we think the data years ago are not valuable for us to draw conclusions to what we want to research. In addition, the dataset of 2019 is not complete, so it may provide wrong information, especially when we want to find the trend by year. Hence, we only use the data from 2008 to 2018 to analyze the plane accidents.
https://www.ntsb.gov/_layouts/ntsb.aviation/index.aspx

## III. Description of data import / cleaning / transformation
The website can only provide XML format dataset, so we use the XML package to deal with the dataset. We first transform the dataset to a list and then transform the list to a dataframe. Then we can work with the dataset in R.
```{r}
library(XML)
dataset.1<-xmlToDataFrame("AviationData.xml")
avi<-xmlParse("AviationData.xml")
list.avi<-xmlToList(avi)
avi.d<-t(data.frame(list.avi,stringsAsFactors = F))
avi.d<-data.frame(avi.d, stringsAsFactors = F)
rownames(avi.d)<-as.character(1:dim(avi.d)[1])
```
As mentioned above, we only use the data from 2008 to 2018, so we extract the year of the Event Date and add a new variable 'year' to help us select the data we want to use.
```{r}
avi.d$year<-regmatches(avi.d$EventDate,regexpr("[0-9]{4}",avi.d$EventDate))
avi.d.r<-avi.d[avi.d$year >= "2008"& avi.d$year!="2019",]
```
Then after observing our dataset, we find that the Column 'InjurySeverity' contains information about the causalties. In addition, it only contains 160 unavailable observations. Hence, we can use the information in Column 'InjurySeverity' to fill in the blank in Column 'TotalFatalInjuries', 'TotalSeriousInjuries', 'TotalMinorInjuries', 'TotalUninjured'. If the observations in Column 'InjurySeverity' are unavailable, we use NA to fill in the blank and we use 0 to fill in the blank otherwise.
```{r}
## Fill in the number about Injuries Using InjurySeverity
fill.in<-function(x)
{
  out<-ifelse(x=="",0,x)
  return(out)
}  
avi.d.r<-data.frame(avi.d.r)
avi.d.r[avi.d.r$InjurySeverity=="Unavailable",]$TotalFatalInjuries<-NA
avi.d.r[avi.d.r$InjurySeverity=="Unavailable",]$TotalSeriousInjuries<-NA
avi.d.r[avi.d.r$InjurySeverity=="Unavailable",]$TotalMinorInjuries<-NA
avi.d.r[avi.d.r$InjurySeverity=="Unavailable",]$TotalUninjured<-NA
avi.d.r[,c("TotalFatalInjuries","TotalSeriousInjuries",
           "TotalMinorInjuries","TotalUninjured")]<-apply(avi.d.r[,c("TotalFatalInjuries","TotalSeriousInjuries",
                          "TotalMinorInjuries","TotalUninjured")],
               2,fill.in)
```

Since the accidents in the dataset are all inclusive, including all severities in terms of loss of life and damage to aircraft, we want to divide all the accidents into 3 category according to its severity. If anyone lost his life or injured seriously in an accident, we assigned it to the 'Fatal or Serious Injuries' category. Then if only someone injured minorly in an accident, we assigned it to the 'Minor Injuries' category. We assigned the other accidents into 'No Injuries' category.
```{r}
avi.d.r$AccidentCategory<-
  ifelse(avi.d.r$TotalMinorInjuries!=0&avi.d.r$TotalFatalInjuries==0
         &avi.d.r$TotalSeriousInjuries==0,"Minor Injuries",
         ifelse(avi.d.r$TotalFatalInjuries!=0|avi.d.r$TotalSeriousInjuries!=0,
                "Fatal or Serious Injuries", "No Injuries"))
```

## IV. Analysis of missing values
As mentioned above, we use the Column 'InjurySeverity' to fill in the blank relevant to causaltites. Then we convert the other blanks to NA and check the missing rate of all variables in the dataset. 
```{r}
## Convert blank to NA
blank.to.na<-function(x)
{
  out<-ifelse(x=="",NA,x)
  return(out)
}
avi.d.r<-apply(avi.d.r,2,blank.to.na)
## Count the missing data in each Column
mis<-function(x)
{
  out<-sum(is.na(x))
  return(out)
}
mis.num<-apply(avi.d.r,2,mis)/dim(avi.d.r)[1]
mis.num
```
There are some variables such as 'AirportCode', 'AirportName', 'Schedule', whose missing rate is very high and they are not relevant to our research, so we should delete these variables.
```{r}
avi.d.r<-avi.d.r[,-9]
avi.d.r<-avi.d.r[,-9]
avi.d.r<-avi.d.r[,-19]
n<-dim(avi.d.r)[1]
```
And as we just want to find the general relationship between the plane accidents and the other variables, we just select those observations which contain the variables we are interested in to find the general relationship. As there are 18810 observations in our dataset, a general trend can be found even if there are some missing values.

## V. Results
### Accidents By Year
First, we count the number of accidents of different years and check if there is any trend of the number of accidents by year. We also include a 3-year-moving-average line to help us find the trend of the number of accidents.
```{r}
library(dplyr)
library(ggplot2)
avi.d.r<-data.frame(avi.d.r)
accidents_by_year<-avi.d.r %>%
         group_by(year) %>%
         count(year)
n.acc.year<-dim(accidents_by_year)[1]
moving.acc<-rep(0,7)
for(i in 1:9)
{
  moving.acc[i]<-mean(accidents_by_year$n[i:i+2])
}
moving.data<-data.frame(year=accidents_by_year$year[3:n.acc.year],m.aver=moving.acc)
label<-c("accidents","3-year-moving-average")
cols.acc.y <- c("3-year-average"="red","accidents"="lightblue")
ggplot()+
  geom_bar(data = data.frame(avi.d.r),aes(x = year,fill="accidents"),col='grey')+
  geom_point(data = moving.data, aes(x = year, y = m.aver,col='3-year-average'))+
  geom_line(data = moving.data, aes(x = year, y = m.aver,group=1,col='3-year-average'))+
  scale_color_manual(name = "Line", values = cols.acc.y)+
  ggtitle(label = "Accidents By Year")+
  ylab("Number of Accidents")+
  xlab("Year")+
  scale_fill_manual(name="Bar",values=cols.acc.y)
```

We can see that the number of aviation accidents are about 1500 after 2013. And as we all know that the number of flights increasingly grows, we can conclude that the accident rate in fact decreases.

### Deaths By Year
There is another problem people are curious about, which is the number of deaths every year. The fatal accidents are worth attention.
```{r}
## Death By year
death_by_year<-avi.d.r %>%
  filter(is.na(TotalFatalInjuries)==F) %>%
  group_by(year) %>%
  summarise(sum(as.numeric(TotalFatalInjuries)))
colnames(death_by_year)<-c("year","death")
ggplot(death_by_year, aes(x=year,y=death))+
  geom_point(col="blue")+
  geom_line(group=1,col="blue")+
  ggtitle("Deaths By Year")+
  xlab("Year")+
  ylab("Death")
```

We can see that the number of deaths decreases with fluctuation. However, there is above 6000 people died in aviation accidents, which is still a surprisingly large number. Hence, we must pay attention to the air transport safety.

### Accident Category By Year
We want to see if the composition of accidents are different year by year, i.e, if the proportion of fatal accidents are the same year by year, so we use a doubledecker plot to check the accident category.
```{r}
## Accident Category By Year
cate_by_year<-avi.d.r %>%
  filter(is.na(AccidentCategory)==F) %>%
  group_by(year) %>%
  count(AccidentCategory)
library(vcd)
vcd::doubledecker(AccidentCategory~year, data=cate_by_year,
                 main="Accident Category By Year",legend_width=6,
                  title_margins = c(1,0),main_gp=gpar(frontsize=16))
```

From the graph, we can find that the proportion of accident category is almost the same every year. It is hard to judge which category takes the largest percentage, so we can analyze a specific year to see the percentage.
```{r}
## Accident Category In 2018
cate_by_year_2018<-avi.d.r %>%
  filter(is.na(AccidentCategory)==F) %>%
  filter(year=='2018') %>%
  group_by(AccidentCategory) %>%
  count(AccidentCategory)
ggplot(cate_by_year_2018, aes(x = AccidentCategory, y = n, fill = AccidentCategory)) +
  geom_col()+
  ggtitle("Accident Category In 2018") +
  ylab("Number of Accidents")+
  xlab("Accident Category")
```

From the graph, the proportion of accident category is shown clearly. The 'No Injuries' Accident takes the largest proportion, the 'Fatal or Serious Injuries' Accident is in the middle and the 'No Injuries' Accident is the least. The result is in line with our common sense.

### Accidents By Phase
Then we want to find the relationship between accidents and phase. We are curious about if there is any stage that the accidents are most likely to take place.
We use a bar plot to find the relationship.
```{r}
## Accidents By Phase
library(tidyverse)
accidents_by_phase<-avi.d.r %>%
  group_by(BroadPhaseOfFlight) %>%
  count(BroadPhaseOfFlight)
n.acc.p<-sum(accidents_by_phase$n)
accidents_by_phase<-accidents_by_phase %>%
  filter(BroadPhaseOfFlight!=""& BroadPhaseOfFlight !="UNKNOWN") %>%
  mutate(rate=n/n.acc.p)
ggplot(data = accidents_by_phase, 
       aes(x= fct_reorder(BroadPhaseOfFlight,rate), rate ))+
  geom_col(fill="lightblue",col="grey")+
  coord_flip()+
  ylab("Broad Phase of Flight")+
  xlab("Number of Accidents")+
  ggtitle(label = "Accidents By Broad Phase of Flight")
```

From the graph, we can see that landing and taking off is the top two phase when the accidents take place, which is in line with our common sense. All the accidents take place at these two phases account for approximately 60 percent of all the accidents. Hence, the landing and taking off phase play an important role in aviation safety.

### Accident Category by Phase
Then, let's do research on if the phase of flight has relationship with the severity of accidents. Since the first five phase takes more than 80 percent, we only do reasearch on that five phases.
```{r}
levels<-c("LANDING","TAKEOFF","MANEUVERING","APPROACH","CRUISE")
cate_by_phase<-avi.d.r %>%
  filter(is.na(BroadPhaseOfFlight)==F) %>%
  filter(is.na(AccidentCategory)==F) %>%
  filter(BroadPhaseOfFlight!=""& BroadPhaseOfFlight !="UNKNOWN") %>%
  filter(BroadPhaseOfFlight=="LANDING"| BroadPhaseOfFlight =="TAKEOFF"|
          BroadPhaseOfFlight =="MANEUVERING"|BroadPhaseOfFlight =="APPROACH"|
           BroadPhaseOfFlight =="CRUISE") %>%
  select(BroadPhaseOfFlight,AccidentCategory)%>%
  mutate(Broad_Phase_new=as.vector(BroadPhaseOfFlight))
library(ggmosaic)
ggplot(data = cate_by_phase)+
  geom_mosaic(aes(x=product(AccidentCategory, Broad_Phase_new ),
                  fill = AccidentCategory),
              divider = c("hspine" , "vspine"))+
  xlab("Accident Category")+
  ylab("Broad Phase") +
  ggtitle("Accident Category By Phase")
```

From the graph, we can find the proportion of different accident categories is different in different broad phase. Although accidents are more likely to happen in landing and take off phase, the 'No Injuries' accidents are the most in these two phases while the 'Fatal or Serious Injuries' accidents are the most in the other three phases. Maybe in the other phases except the landing and take off, it is more difficult to control the severity level of the accidents.

### Accidents By Weather Condition
Next, we discuss whether the number of accidents are related to the weather condition.
First, let's give some explanations of the symbol of weather condition in this dataset. The symbol 'UNK' means unknown and should be deleted when we analyze the data. The symbol 'VMC' means the weather and the vision are good while 'IMC' means the weather or the vision is bad.
```{r}
## Accidents by Weather Condition
accidents_by_weather<-avi.d.r %>%
  filter(is.na(WeatherCondition)==F) %>%
  filter(WeatherCondition!='UNK') %>%
  group_by(WeatherCondition) %>%
  count(WeatherCondition) 
ggplot(data = accidents_by_weather, 
       aes(x= fct_reorder(WeatherCondition,-n), n ))+
  geom_col(fill="lightblue",col="grey")+
  xlab("Weather Condition")+
  ylab("Number of Accidents")+
  ggtitle(label = "Accidents By Weather Condition")
```

The number of accidents under 'VMC' condition is far more than that under 'IMC' condition, which is likely to cause by the number of flights under 'VMC' condition is far more than that under 'IMC' condition.

### Accident Category by Weather Condition
Then we still want to do research on whether the serious accident are more likely to take place under some weather condiitons.
```{r}
## Accidents Category by Weather Condition
cate_by_weather<-avi.d.r %>%
  filter(is.na(WeatherCondition)==F) %>%
  filter(is.na(AccidentCategory)==F) %>%
  filter(WeatherCondition!='UNK') %>%
  select(WeatherCondition,AccidentCategory)%>%
  mutate(w_con_new=as.vector(WeatherCondition))
library(ggmosaic)
ggplot(data = cate_by_weather)+
  geom_mosaic(aes(x=product(AccidentCategory, w_con_new),
                  fill = AccidentCategory),
              divider = c("hspine" , "vspine"))+
  xlab("Accident Category")+ylab("Weather Condition")+
  ggtitle("Accident Category by Weather Condition")
```

We can see that even though most accidents take place under good weather condition, 'Fatal or Serious Injuries' accident takes the largest proportion under 'IMC' while 'No Injuries' takes the largest proportion under 'VMC' condition, which is in line with our common sense. Hence, in bad weather, the severe accidentes are very likely to take place and we must pay more attention to that.

### Death Rate By Weather
```{r}
library(GGally)
## Death and Accidents By Weather
death_by_weather<-avi.d.r %>%
  filter(is.na(TotalFatalInjuries)==F) %>%
  filter(is.na(WeatherCondition)==F) %>%
  filter(WeatherCondition!='UNK') %>%
  group_by(WeatherCondition) %>%
  summarise(sum(as.numeric(TotalFatalInjuries)))
colnames(death_by_weather)<-c("WeatherCondition","death")
death_by_weather<-inner_join(death_by_weather,accidents_by_weather)
death_by_weather<- death_by_weather %>%
  mutate(death_rate=death/n)
p1<-ggplot(data = accidents_by_weather, 
       aes(x= fct_reorder(WeatherCondition,n), n, fill = WeatherCondition))+
  geom_col(col="grey")+
  xlab("Weather Condition")+
  ylab("Number of Accidents")+
  ggtitle(label = "Accidents By Weather Condition")+
  theme(legend.position = "none")
p2<-ggplot(death_by_weather, aes(x=WeatherCondition,y=death_rate,fill = WeatherCondition))+
  geom_col(col="grey")+
  ylab("Death Rate")+
  ggtitle("Deaths By Year")+theme(legend.position = "none")+
  xlab("Weather Condition")
library(gridExtra)
grid.arrange(p1, p2, nrow = 1)
```

From the graph, we can see clearly that even though the number of accidents under 'VMC' is far more than that under 'IMC', the death rate under 'IMC' is much higher than that under 'VMC'. Namely, the death rate in bad weather condition is much higher, so more attention should be paid when the weather is not good. Flights had better not be arranged when the weather condition is bad.

### Accidents By Type of Air Transport
Finally, we want to check the relationships between the number of accidents with the type of air transport. We use the variable FARDescription instead of Purpose of Flight to find the relationship because FARDescription contains information about the regulations that this plane must obey as well as the purpose of the plane, so it may be related to the accidents. For example, 'Part 91:General Aviation' represents small non-commercial aircraft within United States and the oprator must obey the regulations within part 91. The categories in FARDescription are almost clear, and I just want to clarify some categories. Part 135 represents non-scheduled commercial air service while Part 121 represents scheduled air service. And Part 133 anthorize the operator to utilize helicopters to carry external loads. 'Part 91 Subpart K: Fractional' represents the fractional aircraft, which permitted shared ownership of an aircraft. Part 125 represents air plane which can only seat 20 to 6000 passenagers.
```{r}
## Accidents By Type of Air Transport
accidents_by_purpose<-avi.d.r %>%
  filter(is.na(FARDescription)==F) %>%
  filter(FARDescription!='Unknown') %>%
  group_by(FARDescription) %>%
  count(FARDescription)
ggplot(data = accidents_by_purpose, 
       aes(x= fct_reorder(FARDescription,n), n ))+
  geom_col(fill="lightblue",col="grey")+
  xlab("Type of Air Transport")+
  ylab("Number of Accidents")+
  ggtitle(label = "Accidents By Type of Air Transport")+
  coord_flip()
```

We can see that most of the aircrafts which suffered accidents are  non-commercial aircraft within United States. One possible reason is that such kind of air transport takes the largest proportion of all the flights and meanwhile, the regulations of this kind of flights are less strict are another possible reason. 

## VI. Interactive component
```{r}
library(leaflet)

df <- as.data.frame(avi.d.r)
df$Latitude <- as.numeric(as.character(df$Latitude))
df$Longitude <- as.numeric(as.character(df$Longitude))
df$TotalFatalInjuries <- as.numeric(as.character(df$TotalFatalInjuries))
df_expect_ZERO <- filter(df, !is.na(TotalFatalInjuries))
df_expect_ZERO <- filter(df_expect_ZERO, TotalFatalInjuries!=0)
df_expect_ZERO <- filter(df_expect_ZERO, !is.na(Longitude))

content <-  c(NA)
i <- 0
for (i in 1:length(df_expect_ZERO$EventDate)){
content[i] <- base::paste(sep = " <br/>death number:",
  df_expect_ZERO$EventDate[i],
  df_expect_ZERO$TotalFatalInjuries[i]
)
}

df_expect_ZERO$content <- as.character(content)

#find the max fatal case
max(df_expect_ZERO$TotalFatalInjuries)
bins <- c(0, 20, 100, 250)
pal <- colorBin("blue",domain = df_expect_ZERO$TotalFatalInjuries, bins = bins)
pal2 <- colorBin("Blues", domain = df_expect_ZERO$TotalFatalInjuries, bins = bins)

# Show a CUSTOM circle at each position. Size in meters --> change when you zoom.
m=leaflet(data = df_expect_ZERO) %>% addTiles() %>% 
addCircles(~Longitude, ~Latitude, 
radius=~TotalFatalInjuries*500 , 
stroke = T, 
color =  ~pal2(df_expect_ZERO$TotalFatalInjuries),
opacity = 0.1,
fillOpacity = 2,
fillColor = ~pal(df_expect_ZERO$TotalFatalInjuries),

popup = ~as.character(content)
) %>% 
setView( lng = 0, lat = 0, zoom = 4)
m
```

## VII. Conclusion